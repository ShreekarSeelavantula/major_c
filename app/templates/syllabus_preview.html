{% extends "layout.html" %}

{% block title %}Syllabus Preview | Prep Genie{% endblock %}

{% block content %}

<!-- Modern Progress Slider -->
<!-- Amazon Style Flow Progress -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">

        {% set step = 1 %}
        {% if syllabus.status == "subjects_detected" %}
            {% set step = 2 %}
        {% elif syllabus.status == "structured" %}
            {% set step = 3 %}
        {% endif %}

        <div class="mb-4">

            <!-- Labels -->
            <div class="d-flex justify-content-between mb-2 fw-semibold small">
                <span>Preview</span>
                <span>Subjects</span>
                <span>Structured</span>
            </div>

            <!-- Progress Track -->
            <div class="progress-track">
                <div class="progress-fill step-{{ step }}"></div>
            </div>

        </div>

    </div>
</div>



<h2 class="fw-bold mb-2">Syllabus Preview</h2>
<p class="text-muted mb-3">
    Extracted from <strong>{{ syllabus.filename }}</strong>
</p>

<!-- RAW TEXT PREVIEW -->
<div class="card shadow-sm mb-4">
    <div class="card-body">

        <h5 class="fw-semibold mb-2">Extracted Text Preview</h5>

        <pre style="
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        ">
{{ syllabus.preview_text or "No text extracted." }}
        </pre>

        {% if syllabus.error %}
            <div class="alert alert-danger mt-3">
                {{ syllabus.error }}
            </div>
        {% endif %}

        {% if not syllabus.validated %}
            <form method="post"
                  action="/syllabus/validate/{{ syllabus._id }}"
                  class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-success">
                    Validate syllabus →
                </button>
            </form>
        {% endif %}

    </div>
</div>


<!-- VALIDATION SUCCESS -->
{% if syllabus.validated %}

<div class="alert alert-success shadow-sm">
    ✅ Syllabus validated successfully!
</div>

{% endif %}


<!-- SUBJECT SELECTION -->
{% if syllabus.validated and syllabus.subjects_detected and not syllabus.structured_syllabus %}

<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">Select Subject</h4>
            <span class="text-muted small">
                {{ syllabus.subjects_detected | length }} subjects detected
            </span>
        </div>

        <div class="row">

            {% for subject in syllabus.subjects_detected %}
            <div class="col-md-6 mb-4">

                <form method="post"
                      action="/syllabus/structure/{{ syllabus._id }}"
                      class="h-100">

                    <input type="hidden"
                           name="subject_text"
                           value="{{ subject.text }}">

                    <button type="submit"
                            class="subject-card w-100 text-start border-0 bg-white shadow-sm rounded p-4">

                        <div class="d-flex justify-content-between align-items-start">

                            <div>
                                <span class="badge bg-primary mb-2">
                                    {{ subject.course_code }}
                                </span>

                                <h6 class="fw-semibold mb-1">
                                    {{ subject.title }}
                                </h6>

                                <small class="text-muted">
                                    Click to generate structured plan
                                </small>
                            </div>

                            <div class="text-primary fs-5">
                                →
                            </div>

                        </div>

                    </button>

                </form>

            </div>
            {% endfor %}

        </div>

    </div>
</div>

{% endif %}


<!-- STRUCTURED SYLLABUS -->
{% if syllabus.structured_syllabus %}

<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">Structured Syllabus</h4>
            <span class="badge bg-primary">
                {{ syllabus.structured_syllabus | length }} Units
            </span>
        </div>

        <div class="accordion" id="syllabusAccordion">

            {% for unit in syllabus.structured_syllabus %}
            <div class="accordion-item border-0 shadow-sm mb-3 rounded">

                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button collapsed fw-semibold"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ loop.index }}"
                            aria-expanded="false"
                            aria-controls="collapse{{ loop.index }}">

                        <div class="d-flex justify-content-between w-100 me-3">
                            <span>{{ unit.title }}</span>
                            <span class="badge bg-light text-dark">
                                {{ unit.topics | length }} Topics
                            </span>
                        </div>

                    </button>
                </h2>

                <div id="collapse{{ loop.index }}"
                     class="accordion-collapse collapse"
                     aria-labelledby="heading{{ loop.index }}"
                     data-bs-parent="#syllabusAccordion">

                    <div class="accordion-body">

                        <ul class="list-group list-group-flush">
                            {% for topic in unit.topics %}
                            <li class="list-group-item">
                                {{ topic }}
                            </li>
                            {% endfor %}
                        </ul>

                    </div>
                </div>

            </div>
            {% endfor %}

        </div>

        <div class="mt-4 d-flex justify-content-between">
            <a href="/syllabus/change-subject/{{ syllabus._id }}"
               class="btn btn-outline-primary">
                ← Change Subject
            </a>

            <a href="/upload"
               class="btn btn-outline-secondary">
                Re-upload
            </a>
        </div>

    </div>
</div>

{% endif %}

<a href="/upload" class="btn btn-outline-secondary">
    Re-upload
</a>

{% endblock %}
